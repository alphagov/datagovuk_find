env:
  global:
  - NOKOGIRI_USE_SYSTEM_LIBRARIES=true
  - RAILS_ENV=test
  - GIT_COMMITTED_AT=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then git log -1 --pretty=format:%ct;
    else git log -1 --skip 1 --pretty=format:%ct; fi)
sudo: false
language: ruby
cache: bundler
rvm:
- 2.4
services:
- postgresql
- elasticsearch
addons:
  chrome: stable
before_script:
- sleep 10
- curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64
  > ./cc-test-reporter
- chmod +x ./cc-test-reporter
- "./cc-test-reporter before-build"
script:
- bundle exec rake db:create
- bundle exec rake db:migrate
- bundle exec rake spec
after_script:
- if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then ./cc-test-reporter after-build --exit-code
  $TRAVIS_TEST_RESULT; fi
deploy:
  provider: cloudfoundry
  api: https://api.cloud.service.gov.uk
  username: $DEPLOY_USER
  password: $DEPLOY_PASSWORD
  organization: gds-data-discovery
  space: data-gov-uk
  on:
    branch: staging-autodeploy
    repo: datagovuk/find_data_beta
